<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- property details -->
    <template id="property_detail_template" inherit_id="estate.property_detail_template">
        <xpath expr="//div[@id='price']" position="after">
            <t t-if=" property.sale_type == 'auction' and property.auction_started and property.auction_state in ['normal']">
                <div class="mt-3">
                    <h3 class="text-success"><span t-esc="property.time_left"></span></h3>
                </div>
            </t>
        </xpath>

        <xpath expr="//div[@id='tableContainer']" position="replace">
            <t t-if="(property.sale_type == 'auction')">
                <div class="mt-4">
                    <t t-if="property.sale_type == 'auction' and property.auction_started and property.auction_state in ['normal']">
                        <a t-att-href="'/property/%s/offer' % property.id" class="btn btn-primary w-100">
                            Make an Offer <i class="fa fa-arrow-right ms-2"></i>
                        </a>
                    </t>
                </div>
            </t>
            <t t-else="">
                <div class="table-container mt-4 p-4 border rounded bg-light" id="tableContainer" style="width:100%; height:auto;">
                    <h4 class="fw-bold mb-4 text-center" style="font-size: 30px">Offers</h4>
                    
                    <table class="table table-striped text-center">
                        <thead class="table" style="background-color:rgb(106, 87, 101); color: white; font-weight: bold;">
                            <tr>
                                <th style="width: 10%;">Sr.No.</th>
                                <th style="width: 30%;">Offer Price (₹)</th>
                                <th style="width: 20%;">Date Deadline</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-if="property.offer_ids">
                                <t t-set="counter" t-value="1"/>
                                <t t-foreach="property.offer_ids" t-as="offer">
                                    <tr>
                                        <td style="width: 10%; vertical-align: middle;"><span t-esc="counter"/></td>
                                        <td style="width: 30%; vertical-align: middle;"><span t-esc="offer.price"/></td>
                                        <td style="width: 20%; vertical-align: middle;"><span t-esc="offer.date_deadline"/></td>
                                    </tr>
                                    <t t-set="counter" t-value="counter + 1"/>
                                </t>
                            </t>
                            <t t-else="">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        No offers available.
                                    </td>
                                </tr>
                            </t>

                            <!-- Checkbox to Show Form -->
                            <tr>
                                <td colspan="3" class="text-center">
                                    <input type="checkbox" class="btn-check" id="toggleOfferForm" autocomplete="off"/>
                                    <label class="btn btn-outline-primary" for="toggleOfferForm" id="toggleOfferLabel">
                                        ➕ Add New Offer
                                    </label>
                                </td>
                            </tr>

                            <!-- Form Row (Initially Hidden) -->
                            <form t-att-action="'/properties/%s/make-offer' % property.id" method="post">
                                <tr id="offerFormRow" class="hidden-row">
                                    <td style="width: 10%;"></td>
                                    <td style="width: 30%;"><input type="number" name="offer_price" required="1" class="form-control" placeholder="Offer Price" style="text-align:center;"/></td>
                                    <td style="width: 20%;"><input type="date" name="date_validity" required="1" class="form-control" placeholder="Date Deadline" style="text-align:center;"/></td>
                                </tr>

                                <!-- Warning Message Row -->
                                <t t-if="error_message">
                                    <tr id="errorRow">
                                        <td colspan="3">
                                            <div id="errorMessage" class="alert alert-danger text-center">
                                                <t t-esc="error_message"/>
                                            </div>
                                        </td>
                                    </tr>
                                </t>

                                <!-- Submit Button Row -->
                                <tr id="submitRow" class="hidden-row">
                                    <td colspan="2"></td>
                                    <td><button type="submit" class="btn btn-primary">Submit Offer</button></td>
                                </tr>
                            </form>
                        </tbody>
                    </table>
                </div>
            </t>
        </xpath>
    </template>

    <!-- make offer -->
    <template id="make_offer_template" name="Make Offer">
        <t t-call="website.layout">
            <div class="container mt-5 mb-5">
                <div class="card shadow p-4">
                    <h2 class="mb-4 text-center text-primary">Make an Offer {<t t-out="property.name"/>}</h2>

                    <form t-att-action="'/properties/%s/make-offer' % property.id" method="post" class="needs-validation">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Your Name:</label>
                            <input type="text" class="form-control" disabled="disabled" t-att-value="request.env.user.name"/>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Offer Amount:</label>
                            <input type="number" name="offer_price" class="form-control" placeholder="Enter your offer amount" required="required"/>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-check me-1"/> Submit
                            </button>
                            <a t-att-href="'/properties/%s' % property.id" class="btn btn-danger">
                                <i class="fa fa-times me-1"/> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </t>
    </template>

    <!-- filter property -->
    <template id="property_list_filter" inherit_id="estate.property_list_template">
        <xpath expr="//div[@id='property_list']" position="before">
            <!-- Filter Form -->
            <div class="d-flex justify-content-center mb-4">
                <form id="sale-type-form" action="/properties" method="get" onsubmit="updateFormAction()" class="d-flex gap-2 align-items-center">
                    <select name="sale_type" id="sale_type" class="form-select">
                        <option value="">All</option>
                        <option value="auction" t-att-selected="'selected' if request.params.get('sale_type') == 'auction' else None">Auction</option>
                        <option value="regular" t-att-selected="'selected' if request.params.get('sale_type') == 'regular' else None">Regular</option>
                    </select>
                    <button type="submit" class="btn btn-outline-primary">Filter</button>
                </form>
            </div>

            <script>
                function updateFormAction() {
                    const form = document.getElementById('sale-type-form');
                    const type = document.getElementById('sale_type').value;
                    form.action = type ? `/properties/${type}` : `/properties`;
                }
            </script>
        </xpath>
    </template>
</odoo>
