<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="modal_ticket_registration" name="Modal Ticket Registration"
        inherit_id="website_event.modal_ticket_registration">
        <!-- For Multiple Ticket Types -->
        <xpath expr="//t[@t-set='seats_max_ticket']" position="replace">
            <t t-set="seats_max_ticket"
                t-value="min(ticket.seats_available, ticket.maximum_tickets_per_registration) + 1 if ticket and ticket.seats_limited else ticket.maximum_tickets_per_registration + 1" />
        </xpath>

        <xpath expr="//t[@t-set='seats_max_event']" position="replace">
            <t t-set="seats_max_event"
                t-value="min(event.seats_available, ticket.maximum_tickets_per_registration) + 1 if ticket and event.seats_limited else ticket.maximum_tickets_per_registration + 1" />
        </xpath>

        <!-- For Single Ticket Type -->
        <xpath expr="//div[contains(@class, 'o_wevent_registration_single_select')]"
            position="replace">
            <div class="o_wevent_registration_single_select w-auto ms-auto">
                <select t-att-name="'nb_register-%s' % (tickets.id if tickets else 0)"
                    class="d-inline w-auto form-select">

                    <t t-set="ticket_limit"
                        t-value="(tickets.maximum_tickets_per_registration if tickets else event.default_tickets_per_registration)" />

                    <!-- Compute max tickets per user: allow 'ticket_limit' if no limits, else cap at available seats. -->
                    <t t-set="seats_max_ticket"
                        t-value="min(tickets.seats_available, ticket_limit) + 1 if tickets and tickets.seats_limited else ticket_limit + 1" />

                    <!-- Compute max tickets per user for the event: allow 'ticket_limit' if no limits, else cap at available event seats. -->
                    <t t-set="seats_max_event"
                        t-value="min(event.seats_available, ticket_limit) +1 if tickets and event.seats_limited else ticket_limit + 1" />

                    <!-- Determine final max selectable tickets: use min of 'seats_max_ticket' & 'seats_max_event' if ticket-specific, else default/event seats. -->
                    <t t-set="seats_max"
                        t-value="min(seats_max_ticket, seats_max_event) if tickets
                                else min(ticket_limit, event.seats_available) + 1 if event.seats_limited else ticket_limit + 1" />

                    <t t-foreach="range(1, seats_max)" t-as="nb">
                        <option t-out="nb" t-att-selected="nb == 1 and 'selected'" />
                    </t>
                </select>
            </div>
        </xpath>
    </template>
</odoo>
